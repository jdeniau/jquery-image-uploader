void 0!==typeof jQuery&&!function($){var ImageUploader=function(params){this.currentThumbnail=null,this.options=[],this.init(params),this.main()};ImageUploader.defaults={fileField:null,urlField:null,urlFieldSubmit:null,hideFileField:!0,hideUrlField:!0,url:null,thumbnails:{div:null,width:null,height:null},maxFileSize:0,allowDuplicate:!1,thumbnailReady:$.noop,onFileAdded:function(file){return!1},onFilesSelected:function(){return!1},onUrlSelected:function(){return!1},onDragStart:function(event){return!1},onDragEnd:function(event){return!1},onDragEnter:function(event){return!1},onDragLeave:function(event){return!1},onDragOver:function(event){return!1},onDrop:function(event){return!1},onUploadProgress:function(event){return!1},beforeUpload:function(){return!0},afterUpload:function(){return!1},error:function(msg){alert(msg)}},ImageUploader.prototype={init:function(params){this.options=$.extend({},ImageUploader.defaults,params),this.canUpload=!0,this.uploadFileList=new Array,this.allUploadedFileList=new Array,this.currentThumbnail=null},fileApiSupported:function(){return window.File&&window.FileReader&&window.FileList&&window.FormData},onDragLeave:function(event){return $(event.target)[0]===event.data.instance.options.dropZone[0]?event.data.instance.options.onDragLeave(event):void 0},onDragEnter:function(event){return $(event.target)[0]===event.data.instance.options.dropZone[0]?event.data.instance.options.onDragEnter(event):void 0},onDragStart:function(event){return event.preventDefault(),event.stopPropagation(),event.data.instance.options.onDragStart(event)},onDragEnd:function(event){return event.preventDefault(),event.stopPropagation(),event.data.instance.options.onDragEnd(event)},onDragOver:function(event){return event.preventDefault(),event.stopPropagation(),event.data.instance.options.onDragOver(event)},onDrop:function(event){return event.preventDefault(),event.stopPropagation(),event.data.instance.addFiles(event.originalEvent.dataTransfer.files),event.data.instance.options.onDrop(event)},uploadStarted:function(event){this.options.thumbnails&&(this.currentThumbnail=this.options.thumbnails.div.find('[data-upload-status="waiting"]:first'),this.currentThumbnail.attr("data-upload-status","uploading"),this.currentThumbnail.append($('<div class="progress" />').append($("<div />"))))},onUploadProgress:function(event){return event.lengthComputable&&(this.currentThumbnail&&0!=this.currentThumbnail.length||this.uploadStarted(),this.currentThumbnail&&this.currentThumbnail.find(".progress > div").width(100*event.loaded/event.total+"%")),this.options.onUploadProgress(event)},uploadComplete:function(event){if(xhr=event.currentTarget,this.canUpload=!0,200==xhr.status){var thumbnailToReturn=null;this.currentThumbnail&&(this.currentThumbnail.find(".progress > div").width("100%"),thumbnailToReturn=this.currentThumbnail,this.currentThumbnail=null),this.options.afterUpload(event.target.response,thumbnailToReturn),this.uploadNextFile()}else this.uploadFailed()},uploadFailed:function(){this.canUpload=!0,this.currentThumbnail&&this.currentThumbnail.remove(),this.currentThumbnail=null,this.options.error("upload failed"),this.uploadNextFile()},uploadCanceled:function(){this.canUpload=!0,this.currentThumbnail=null,this.options.error("upload canceled"),this.uploadNextFile()},addUploadFile:function(file){this.allUploadedFileList.push(file),this.uploadFileList.push(file),this.uploadNextFile()},fileAlreadyUploaded:function(file){for(i in this.allUploadedFileList)if(f=this.allUploadedFileList[i],file.name==f.name&&file.size==f.size&&file.type==f.type)return!0;return!1},uploadNextFile:function(){this.canUpload&&this.uploadFileList.length>0&&(file=this.uploadFileList.shift(),this.canUpload=!1,this.uploadFile(file))},uploadFile:function(file){if(xhr=new XMLHttpRequest,xhr.upload&&this.options.beforeUpload()){if(xhr.open("POST",this.options.url),file instanceof File){var fd=new FormData;fd.append("file",file)}else{xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");var fd="url="+encodeURIComponent(file.name)}xhr.upload.addEventListener("progress",this.onUploadProgress.bind(this),!1),xhr.addEventListener("loadstart",this.uploadStarted.bind(this),!1),xhr.addEventListener("load",this.uploadComplete.bind(this),!1),xhr.addEventListener("error",this.uploadFailed.bind(this),!1),xhr.addEventListener("abort",this.uploadCanceled.bind(this),!1),xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),xhr.send(fd)}},onFilesSelected:function(event){return event.preventDefault(),event.stopPropagation(),event.data.instance.addFiles(event.target.files),$(this).val(""),event.data.instance.options.onFilesSelected()},onUrlSelected:function(event){var instance=event.data.instance,url=instance.options.urlField.val();return url&&instance.addFileByUrl(url),instance.options.onUrlSelected()},addFileByUrl:function(url){return this.addFile({name:url})},addFile:function(file){return this.addFiles([file])},addFiles:function(files){if(this.fileApiSupported())for(var reader=null,i=0;i<files.length;i++){if(this.options.maxFileSize>0&&file.size>this.options.maxFileSize)return this.options.error("the file you are trying to upload is too big");if(!this.options.allowDuplicate&&this.fileAlreadyUploaded(files[i]))return this.options.error("the file you are trying to upload has already been sent");if(this.options.onFileAdded(files[i]),this.options.thumbnails||this.options.thumbnailReady!=$.noop)if(files[i]instanceof File){this.options.thumbnails.div.file=files[i],reader=new FileReader;var _this=this;reader.onload=function(evt){_this.displayImage(evt.target.result)},reader.readAsDataURL(files[i])}else this.displayImage(files[i].name);try{this.addUploadFile(files[i])}catch(e){this.uploadFailed()}}else alert("files api not supported")},displayImage:function(src){var thumb=new Image;thumb.src=src,$(thumb).hide();var thumbContainer=$("<div />").attr("data-upload-status","waiting").css({overflow:"hidden",position:"relative"}).append(thumb),_this=this;thumb.onload=function(){var otw=_this.options.thumbnails.width,oth=_this.options.thumbnails.height,ratio=thumb.width/thumb.height;if(_this.options.thumbnails.crop&&otw>0&&oth>0){thumbContainer.width(otw),thumbContainer.height(oth),$(thumb).css("position","absolute");var wantedRatio=otw/oth;wantedRatio>ratio?"zoom"==_this.options.thumbnails.crop?(thumb.width=otw,thumb.height=otw/ratio,$(thumb).css("top","-"+parseInt((thumb.height-oth)/2)+"px")):(thumb.width=oth*ratio,thumb.height=oth,$(thumb).css("left",parseInt((otw-thumb.width)/2)+"px")):"zoom"==_this.options.thumbnails.crop?(thumb.height=oth,thumb.width=oth*ratio,$(thumb).css("left","-"+parseInt((thumb.width-otw)/2)+"px")):(thumb.width=otw,thumb.height=oth/ratio,$(thumb).css("top",parseInt((oth-thumb.height)/2)+"px"))}else otw>0?thumb.width=otw:oth>0&&(thumb.width=oth*ratio),oth>0?thumb.height=oth:otw>0&&(thumb.height=otw/ratio);$(thumb).css({width:thumb.width,height:thumb.height}),$(thumb).show("slow")},this.options.thumbnailReady!=$.noop?this.options.thumbnailReady(thumbContainer):this.options.thumbnails.div.append(thumbContainer)},prepareThumbnails:function(){if(this.options.thumbnails){if("object"!=typeof this.options.thumbnails){var tmpDiv=null;"string"==typeof this.options.thumbnails&&(tmpDiv=$(this.options.thumbnails)),this.options.thumbnails={div:tmpDiv,width:null,height:null}}"string"==typeof this.options.thumbnails.div&&(this.options.thumbnails.div=$(this.options.thumbnails.div)),"object"==typeof this.options.thumbnails&&void 0==this.options.thumbnails.div&&(this.options.thumbnails.div=null),null==this.options.thumbnails.div&&(this.options.thumbnails.div=$('<div class="fileUploadThumbnails" />'),this.options.dropZone.after(this.options.thumbnails.div))}},main:function(){var _this=this;return null!=this.options.dropZone&&(this.options.dropZone.on("dragstart",{instance:this},this.onDragStart),this.options.dropZone.on("dragend",{instance:this},this.onDragEnd),this.options.dropZone.on("dragleave",{instance:this},this.onDragLeave),this.options.dropZone.on("dragenter",{instance:this},this.onDragEnter),this.options.dropZone.on("dragover",{instance:this},this.onDragOver),this.options.dropZone.on("drop",{instance:this},this.onDrop)),null!=this.options.fileField&&("string"==typeof this.options.fileField&&(this.options.fileField=$(this.options.fileField)),this.options.dropZone.on("click",function(){_this.options.fileField.trigger("click")}),this.options.fileField.on("change",{instance:this},this.onFilesSelected),1==this.options.hideFileField&&this.hide(this.options.fileField)),null!=this.options.urlField&&("string"==typeof this.options.urlField&&(this.options.urlField=$(this.options.urlField)),null!==this.options.urlFieldSubmit?("string"==typeof this.options.urlFieldSubmit&&(this.options.urlFieldSubmit=$(this.options.urlFieldSubmit)),this.options.urlFieldSubmit.on("click",{instance:this},this.onUrlSelected)):this.options.urlField.on("change",{instance:this},this.onUrlSelected),1==this.options.hideUrlField&&this.hide(this.options.urlField)),this.prepareThumbnails(),this},hide:function($element){$element.css({width:"0px",height:"0px",padding:"0px",margin:"0px",border:"none"})}},$.fn.imageUploader=function(params){params=$.extend({dropZone:$(this)},params);var instance=new ImageUploader(params);return $(this).data("imageUploader",instance),this}}(jQuery);
