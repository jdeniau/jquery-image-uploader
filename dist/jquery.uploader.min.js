/*!
 * ImageUploader (for jQuery)
 * Version 0.3.4 (26/01/2015)
 * Copyright 2012-* Julien Deniau <julien.deniau@gmail.com>
 * Licensed under MIT (https://github.com/jdeniau/jquery-image-uploader/LICENSE.md)
 */
void 0!==typeof jQuery&&!function(t){var n=function(t){this.init(t),this.main()};n.defaults={fileField:null,urlField:null,urlFieldSubmit:null,hideFileField:!0,hideUrlField:!0,url:null,thumbnails:{div:null,width:null,height:null},maxFileSize:0,allowDuplicate:!1,thumbnailReady:t.noop,onFileAdded:function(){return!1},onFilesSelected:function(){return!1},onUrlSelected:function(){return!1},onDragStart:function(){return!1},onDragEnd:function(){return!1},onDragEnter:function(){return!1},onDragLeave:function(){return!1},onDragOver:function(){return!1},onDrop:function(){return!1},onUploadProgress:function(){return!1},beforeUpload:function(){return!0},afterUpload:function(){return!1},error:function(t){alert(t)}},n.prototype={init:function(i){instance=this,this.options=t.extend({},n.defaults,i),this.canUpload=!0,this.uploadFileList=[],this.allUploadedFileList=[],this.currentThumbnail=null},fileApiSupported:function(){return window.File&&window.FileReader&&window.FileList&&window.FormData},onDragLeave:function(i){return t(i.target)[0]===instance.options.dropZone[0]?instance.options.onDragLeave(i):void 0},onDragEnter:function(i){return t(i.target)[0]===instance.options.dropZone[0]?instance.options.onDragEnter(i):void 0},onDragStart:function(t){return t.preventDefault(),t.stopPropagation(),instance.options.onDragStart(t)},onDragEnd:function(t){return t.preventDefault(),t.stopPropagation(),instance.options.onDragEnd(t)},onDragOver:function(t){return t.preventDefault(),t.stopPropagation(),instance.options.onDragOver(t)},onDrop:function(t){return t.preventDefault(),t.stopPropagation(),instance.addFiles(t.originalEvent.dataTransfer.files),instance.options.onDrop(t)},uploadStarted:function(){instance.options.thumbnails&&(instance.currentThumbnail=instance.options.thumbnails.div.find('[data-upload-status="waiting"]:first'),instance.currentThumbnail.attr("data-upload-status","uploading"),instance.currentThumbnail.append(t('<div class="progress" />').append(t("<div />"))))},onUploadProgress:function(t){return t.lengthComputable&&(instance.currentThumbnail&&0!=instance.currentThumbnail.length||instance.uploadStarted(),instance.currentThumbnail&&instance.currentThumbnail.find(".progress > div").width(100*t.loaded/t.total+"%")),instance.options.onUploadProgress(t)},uploadComplete:function(t){if(xhr=t.currentTarget,instance.canUpload=!0,200==xhr.status){var i=null;instance.currentThumbnail&&(instance.currentThumbnail.find(".progress > div").width("100%"),i=instance.currentThumbnail,instance.currentThumbnail=null),instance.options.afterUpload(t.target.response,i),instance.uploadNextFile()}else instance.uploadFailed()},uploadFailed:function(){this.canUpload=!0,this.currentThumbnail&&this.currentThumbnail.remove(),this.currentThumbnail=null,this.options.error("upload failed"),this.uploadNextFile()},uploadCanceled:function(){this.canUpload=!0,this.currentThumbnail=null,this.options.error("upload canceled"),this.uploadNextFile()},addUploadFile:function(t){this.allUploadedFileList.push(t),this.uploadFileList.push(t),this.uploadNextFile()},fileAlreadyUploaded:function(t){for(i in this.allUploadedFileList)if(f=this.allUploadedFileList[i],t.name==f.name&&t.size==f.size&&t.type==f.type)return!0;return!1},uploadNextFile:function(){this.canUpload&&this.uploadFileList.length>0&&(file=this.uploadFileList.shift(),this.canUpload=!1,this.uploadFile(file))},uploadFile:function(t){if(xhr=new XMLHttpRequest,xhr.upload&&this.options.beforeUpload()){if(xhr.open("POST",this.options.url),t instanceof File){var i=new FormData;i.append("file",t)}else{xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");var i="url="+encodeURIComponent(t.name)}xhr.upload.addEventListener("progress",this.onUploadProgress,!1),xhr.addEventListener("loadstart",this.uploadStarted,!1),xhr.addEventListener("load",this.uploadComplete,!1),xhr.addEventListener("error",this.uploadFailed,!1),xhr.addEventListener("abort",this.uploadCanceled,!1),xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),xhr.send(i)}},onFilesSelected:function(i){return i.preventDefault(),i.stopPropagation(),instance.addFiles(i.target.files),t(this).val(""),instance.options.onFilesSelected()},onUrlSelected:function(){var t=instance.options.urlField.val();return t&&instance.addFileByUrl(t),instance.options.onUrlSelected()},addFileByUrl:function(t){return this.addFile({name:t})},addFile:function(t){return this.addFiles([t])},addFiles:function(i){if(this.fileApiSupported())for(var n=null,e=0;e<i.length;e++){if(this.options.maxFileSize>0&&file.size>this.options.maxFileSize)return this.options.error("the file you are trying to upload is too big");if(!this.options.allowDuplicate&&this.fileAlreadyUploaded(i[e]))return this.options.error("the file you are trying to upload has already been sent");this.options.onFileAdded(i[e]),(this.options.thumbnails||this.options.thumbnailReady!=t.noop)&&(i[e]instanceof File?(this.options.thumbnails.div.file=i[e],n=new FileReader,n.onload=function(t){instance.displayImage(t.target.result)},n.readAsDataURL(i[e])):this.displayImage(i[e].name));try{this.addUploadFile(i[e])}catch(o){this.uploadFailed()}}else alert("files api not supported")},displayImage:function(i){var n=new Image;n.src=i,t(n).hide();var e=t("<div />").attr("data-upload-status","waiting").css({overflow:"hidden",position:"relative"}).append(n);n.onload=function(){var i=instance.options.thumbnails.width,o=instance.options.thumbnails.height,s=n.width/n.height;if(instance.options.thumbnails.crop&&i>0&&o>0){e.width(i),e.height(o),t(n).css("position","absolute");var a=i/o;a>s?"zoom"==instance.options.thumbnails.crop?(n.width=i,n.height=i/s,t(n).css("top","-"+parseInt((n.height-o)/2)+"px")):(n.width=o*s,n.height=o,t(n).css("left",parseInt((i-n.width)/2)+"px")):"zoom"==instance.options.thumbnails.crop?(n.height=o,n.width=o*s,t(n).css("left","-"+parseInt((n.width-i)/2)+"px")):(n.width=i,n.height=o/s,t(n).css("top",parseInt((o-n.height)/2)+"px"))}else i>0?n.width=i:o>0&&(n.width=o*s),o>0?n.height=o:i>0&&(n.height=i/s);t(n).css({width:n.width,height:n.height}),t(n).show("slow")},instance.options.thumbnailReady!=t.noop?instance.options.thumbnailReady(e):instance.options.thumbnails.div.append(e)},prepareThumbnails:function(){if(this.options.thumbnails){if("object"!=typeof this.options.thumbnails){var i=null;"string"==typeof this.options.thumbnails&&(i=t(this.options.thumbnails)),this.options.thumbnails={div:i,width:null,height:null}}"string"==typeof this.options.thumbnails.div&&(this.options.thumbnails.div=t(this.options.thumbnails.div)),"object"==typeof this.options.thumbnails&&void 0==this.options.thumbnails.div&&(this.options.thumbnails.div=null),null==this.options.thumbnails.div&&(this.options.thumbnails.div=t('<div class="fileUploadThumbnails" />'),this.options.dropZone.after(this.options.thumbnails.div))}},main:function(){var i=this;return null!=this.options.dropZone&&(this.options.dropZone.on("dragstart",this.onDragStart),this.options.dropZone.on("dragend",this.onDragEnd),this.options.dropZone.on("dragleave",this.onDragLeave),this.options.dropZone.on("dragenter",this.onDragEnter),this.options.dropZone.on("dragover",this.onDragOver),this.options.dropZone.on("drop",this.onDrop)),null!=this.options.fileField&&("string"==typeof this.options.fileField&&(this.options.fileField=t(this.options.fileField)),this.options.dropZone.on("click",function(){i.options.fileField.trigger("click")}),this.options.fileField.on("change",this.onFilesSelected),1==this.options.hideFileField&&this.hide(this.options.fileField)),null!=this.options.urlField&&("string"==typeof this.options.urlField&&(this.options.urlField=t(this.options.urlField)),null!==this.options.urlFieldSubmit?("string"==typeof this.options.urlFieldSubmit&&(this.options.urlFieldSubmit=t(this.options.urlFieldSubmit)),this.options.urlFieldSubmit.on("click",this.onUrlSelected)):this.options.urlField.on("change",this.onUrlSelected),1==this.options.hideUrlField&&this.hide(this.options.urlField)),this.prepareThumbnails(),this},hide:function(t){t.css({width:"0px",height:"0px",padding:"0px",margin:"0px",border:"none"})}},t.fn.imageUploader=function(i){i=t.extend({dropZone:t(this)},i);var e=new n(i);return t(this).data("imageUploader",e),this}}(jQuery);